import{_ as s,c as e,o as n,aj as i}from"./chunks/framework.iQ8U7nGd.js";const g=JSON.parse('{"title":"存储过程","description":"","frontmatter":{},"headers":[],"relativePath":"pages/Documents/SQL/11：存储.md","filePath":"pages/Documents/SQL/11：存储.md","lastUpdated":1770663692000}'),l={name:"pages/Documents/SQL/11：存储.md"};function t(p,a,h,r,c,d){return n(),e("div",null,[...a[0]||(a[0]=[i(`<h1 id="存储过程" tabindex="-1">存储过程 <a class="header-anchor" href="#存储过程" aria-label="Permalink to “存储过程”">​</a></h1><p>---类似于函数的思想</p><p>在操作数据库的时候，每条语句都会建立一次链接，这造成了很大的开销，我们可以把一些SQL存储到数据库本身，外部调用仅仅掉用这个SQL集合就可以实现一系列操作，我们把这个集合叫做存储过程。</p><p><strong>特点</strong>：</p><p>​ 1：封装，复用 ​ 2：可以接受参数，返回结果 ​ 3：减少网络开支</p><h2 id="创建" tabindex="-1">创建 <a class="header-anchor" href="#创建" aria-label="Permalink to “创建”">​</a></h2><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>create procedure procedure_name ([参数])</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>    存储体语句;</span></span>
<span class="line"><span>end;</span></span></code></pre></div><hr><h2 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-label="Permalink to “使用”">​</a></h2><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>call procedure_name([参数]);</span></span></code></pre></div><hr><h2 id="查询" tabindex="-1">查询 <a class="header-anchor" href="#查询" aria-label="Permalink to “查询”">​</a></h2><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># 根据主机名查看</span></span>
<span class="line"><span>select * from information_schema.ROUTINES</span></span>
<span class="line"><span>    where ROUTINE_SCHEMA = &#39;数据库名称&#39;;</span></span>
<span class="line"><span># 根据存储过程名查看</span></span>
<span class="line"><span>show create procedure p1;</span></span></code></pre></div><hr><h2 id="删除" tabindex="-1">删除 <a class="header-anchor" href="#删除" aria-label="Permalink to “删除”">​</a></h2><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>drop procedure if exists procedure_name;</span></span></code></pre></div><hr><h2 id="变量" tabindex="-1">变量 <a class="header-anchor" href="#变量" aria-label="Permalink to “变量”">​</a></h2><h3 id="系统变量" tabindex="-1">系统变量 <a class="header-anchor" href="#系统变量" aria-label="Permalink to “系统变量”">​</a></h3><p>由mysql数据库创建，不是由用户定义的，属于服务器层面，分为全局变量【global】和回话变量【session】用 @@变量名 表示；</p><h4 id="查看系统变量" tabindex="-1">查看系统变量 <a class="header-anchor" href="#查看系统变量" aria-label="Permalink to “查看系统变量”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>show [global | session(默认)] variables [like ...];</span></span>
<span class="line"><span># 也可以指定变量查找</span></span>
<span class="line"><span>select @@ [global | session] 系统变量名;</span></span></code></pre></div><hr><h4 id="设置系统变量" tabindex="-1">设置系统变量 <a class="header-anchor" href="#设置系统变量" aria-label="Permalink to “设置系统变量”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>set [@@] [global | session] 系统变量名 = 值;</span></span></code></pre></div><hr><h3 id="用户变量" tabindex="-1">用户变量 <a class="header-anchor" href="#用户变量" aria-label="Permalink to “用户变量”">​</a></h3><p>用户变量不需要提前声明，在使用的时候直接用 @变量名 就可以使用，作用域为当前会话</p><h4 id="赋值" tabindex="-1">赋值 <a class="header-anchor" href="#赋值" aria-label="Permalink to “赋值”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># 方法一</span></span>
<span class="line"><span>set @var_name [:]= 值 [,@var_name = 值];</span></span>
<span class="line"><span># 方法二</span></span>
<span class="line"><span>select @var_name [:]= 值 [,@var_name = 值];</span></span>
<span class="line"><span># 方法三</span></span>
<span class="line"><span>select 字段名 into @Var_name from table_name;</span></span></code></pre></div><hr><h4 id="使用-1" tabindex="-1">使用 <a class="header-anchor" href="#使用-1" aria-label="Permalink to “使用”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>select @var_name [,@var_name];</span></span></code></pre></div><p>如果使用了一个没有初始化的变量，就会返回一个负值</p><hr><h3 id="局部变量" tabindex="-1">局部变量 <a class="header-anchor" href="#局部变量" aria-label="Permalink to “局部变量”">​</a></h3><p>局部变量需要声明才能使用，生命周期在一段 begin和end中。</p><h4 id="声明" tabindex="-1">声明： <a class="header-anchor" href="#声明" aria-label="Permalink to “声明：”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>declare var_name 变量类型 [default];</span></span></code></pre></div><p><strong>default</strong>：指定变量默认值；</p><hr><h4 id="赋值-1" tabindex="-1">赋值 <a class="header-anchor" href="#赋值-1" aria-label="Permalink to “赋值”">​</a></h4><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># 方法一</span></span>
<span class="line"><span>set @var_name [:]= 值 [,@var_name = 值];</span></span>
<span class="line"><span># 方法二</span></span>
<span class="line"><span>select @var_name [:]= 值 [,@var_name = 值];</span></span>
<span class="line"><span># 方法三</span></span>
<span class="line"><span>select 字段名 into @Var_name from table_name;</span></span></code></pre></div><hr><h2 id="if" tabindex="-1">if <a class="header-anchor" href="#if" aria-label="Permalink to “if”">​</a></h2><h3 id="结构" tabindex="-1">结构 <a class="header-anchor" href="#结构" aria-label="Permalink to “结构”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>if 条件 then</span></span>
<span class="line"><span>	结果</span></span>
<span class="line"><span>elseif 条件 then</span></span>
<span class="line"><span>	结果</span></span>
<span class="line"><span>else</span></span>
<span class="line"><span>	结果</span></span>
<span class="line"><span>end if;</span></span></code></pre></div><h2 id="参数" tabindex="-1">参数 <a class="header-anchor" href="#参数" aria-label="Permalink to “参数”">​</a></h2><p><img src="https://banxia-log.oss-cn-beijing.aliyuncs.com/MySQL/%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B.png" alt=""></p><h3 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to “示例”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>create procedure p2(in s int,out str varchar(10),inout teacher_name varchar(10))</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>    set teacher_name := concat(substring(teacher_name,1,1),&#39;老师&#39;);</span></span>
<span class="line"><span>    if s &gt;= 60 then</span></span>
<span class="line"><span>        set str := &#39;及格&#39;;</span></span>
<span class="line"><span>    else</span></span>
<span class="line"><span>        set str := &#39;及格&#39;;</span></span>
<span class="line"><span>    end if;</span></span>
<span class="line"><span>end;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>set @teacher_name = &#39;王天正&#39;;</span></span>
<span class="line"><span>call p2(60,@str,@teacher_name);</span></span>
<span class="line"><span>select @str,@teacher_name;</span></span></code></pre></div><hr><h2 id="case" tabindex="-1">case <a class="header-anchor" href="#case" aria-label="Permalink to “case”">​</a></h2><h3 id="结构-1" tabindex="-1">结构 <a class="header-anchor" href="#结构-1" aria-label="Permalink to “结构”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># 结构一：通过比较值是否相等，判断执行哪一条语句</span></span>
<span class="line"><span>case 值</span></span>
<span class="line"><span>	when 值 SQL</span></span>
<span class="line"><span>	[when 值 SQL]</span></span>
<span class="line"><span>	[else SQL]</span></span>
<span class="line"><span>end case;</span></span>
<span class="line"><span># 结构一：通过判断每条分支表达式的值，来决定执行哪一条语句</span></span>
<span class="line"><span>case</span></span>
<span class="line"><span>	when 表达式 SQL</span></span>
<span class="line"><span>	[when 表达式 SQL]</span></span>
<span class="line"><span>	[else SQL]</span></span>
<span class="line"><span>end case;</span></span></code></pre></div><hr><h2 id="循环" tabindex="-1">循环 <a class="header-anchor" href="#循环" aria-label="Permalink to “循环”">​</a></h2><h3 id="while" tabindex="-1">while <a class="header-anchor" href="#while" aria-label="Permalink to “while”">​</a></h3><p>while别看长得像do-while 其实就是while</p><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>while 条件 do </span></span>
<span class="line"><span>	SQL...</span></span>
<span class="line"><span>end while;</span></span></code></pre></div><hr><h3 id="repeat" tabindex="-1">repeat <a class="header-anchor" href="#repeat" aria-label="Permalink to “repeat”">​</a></h3><p>其实是do-while....不对！repeat是满足条件就退出，而不是满足条件就继续执行！！！</p><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>repeat</span></span>
<span class="line"><span>	SQL...</span></span>
<span class="line"><span>	until 条件</span></span>
<span class="line"><span>end repeat;</span></span></code></pre></div><hr><h3 id="loop-leave-iterate" tabindex="-1">loop + leave + iterate <a class="header-anchor" href="#loop-leave-iterate" aria-label="Permalink to “loop + leave + iterate”">​</a></h3><p><strong>loop</strong>：可以理解成简单的无限循环 <strong>leave</strong>：break <strong>iterate</strong>：continue</p><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>[标记名:]loop</span></span>
<span class="line"><span>	SQL...</span></span>
<span class="line"><span>end loop [标记名];</span></span></code></pre></div><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span># 离开当前标记</span></span>
<span class="line"><span>leave 标记名</span></span>
<span class="line"><span># 执行下一次标记</span></span>
<span class="line"><span>iterate 标记名</span></span></code></pre></div><hr><h2 id="游标-cursor" tabindex="-1">游标 cursor <a class="header-anchor" href="#游标-cursor" aria-label="Permalink to “游标 cursor”">​</a></h2><p>从目前看来，存储过程所返回的变量只有SQL基础的数据类型所创建的变量，但是很多时候，我们拿到的数据并不是单个的数据，通常作为一个表出现，这就出现了多对一的矛盾，为了解决这个矛盾，出现了游标</p><h3 id="声明-1" tabindex="-1">声明 <a class="header-anchor" href="#声明-1" aria-label="Permalink to “声明”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>declare 游标名称 cursor for 查询语句;</span></span></code></pre></div><p>注意，声明游标语句必须存在在变量之后</p><h3 id="开启" tabindex="-1">开启 <a class="header-anchor" href="#开启" aria-label="Permalink to “开启”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>open 游标名称</span></span></code></pre></div><h3 id="获取" tabindex="-1">获取 <a class="header-anchor" href="#获取" aria-label="Permalink to “获取”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>fetch 游标名称 into 变量 [,变量];</span></span></code></pre></div><h3 id="关闭" tabindex="-1">关闭 <a class="header-anchor" href="#关闭" aria-label="Permalink to “关闭”">​</a></h3><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>close 游标名称</span></span></code></pre></div><hr><h2 id="条件处理程序-handler" tabindex="-1">条件处理程序 handler <a class="header-anchor" href="#条件处理程序-handler" aria-label="Permalink to “条件处理程序 handler”">​</a></h2><p>在读取游标数据时，一般情况下会用到无限循环去读取，当游标为空的时候，我们再去读取就会报错，有没有不报错解决办法呢， 答案是没有，但是我们可以对错误进行处理，不让错误出现</p><p>就诞生了条件处理程序，感觉和java和py的错误处理差不错</p><h3 id="创建-1" tabindex="-1">创建 <a class="header-anchor" href="#创建-1" aria-label="Permalink to “创建”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>declare handler_action handler for condition_value [,condition——value] statement;</span></span></code></pre></div><p><strong>handler_action</strong>：发现错误后执行的操作 <strong>exit</strong>：直接退出 <strong>continue</strong>：继续执行(?)</p><p><strong>handler_action</strong>：捕捉错误 sqlstate + 状态码 sqlwarning 以01开头的状态码 not found 以02开头的状态码 sqlexception 上面二者的补集</p><p>对于上述的错误码，在SQL的官方文档有记载，不过让他先出错再修理可能更有效率（？</p><p><strong>statement</strong>：执行的SQL</p><hr><h1 id="存储函数" tabindex="-1">存储函数 <a class="header-anchor" href="#存储函数" aria-label="Permalink to “存储函数”">​</a></h1><p>存储函数是存储过程的特殊表现形式， 存储函数被要求是有返回值的存储过程，并且参数全部是 in 类型</p><div class="language-mysql"><button title="Copy Code" class="copy"></button><span class="lang">mysql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>create function 存储函数名称(参数列表)</span></span>
<span class="line"><span>returns 返回值类型 [characteristic]</span></span>
<span class="line"><span>begin</span></span>
<span class="line"><span>	SQL...</span></span>
<span class="line"><span>    return 返回值;</span></span>
<span class="line"><span>end;</span></span></code></pre></div><p><strong>characteristic</strong>： <strong>deterministic</strong>：相同的数据会产生相同的结果 <strong>no sql</strong>：不包含SQL语句 <strong>reads sql data</strong>：包含读取数据的语句，但不包含写入数据的语句</p><hr><h1 id="" tabindex="-1"><a class="header-anchor" href="#" aria-label="Permalink to “”">​</a></h1>`,98)])])}const k=s(l,[["render",t]]);export{g as __pageData,k as default};
